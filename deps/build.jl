using Libdl

const depsfile = joinpath(@__DIR__, "deps.jl")

libpath = get(ENV, "JULIA_HDF5_PATH", get(ENV, "JULIA_HDF5_LIBRARY_PATH", nothing)) # legacy env variable for compatibility

# We avoid calling Libdl.find_library to avoid possible segfault when calling
# dlclose (#929).
# The only difference with Libdl.find_library is that we allow custom dlopen
# flags via the `flags` argument.
function find_library_alt(libnames, extrapaths=String[]; flags=RTLD_LAZY)
    for lib in libnames
        for path in extrapaths
            l = joinpath(path, lib)
            p = dlopen(l, flags; throw_error=false)
            if p !== nothing
                dlclose(p)
                return l
            end
        end
        p = dlopen(lib, flags; throw_error=false)
        if p !== nothing
            dlclose(p)
            return lib
        end
    end
    return ""
end

##

new_contents = if libpath === nothing
    # By default, use HDF5_jll
    """
    # This file is automatically generated
    # Do not edit
    using HDF5_jll
    check_deps() = nothing
    """
else
    @info "using system HDF5"

    libpaths = [libpath, joinpath(libpath, "lib"), joinpath(libpath, "lib64")]
    flags = RTLD_LAZY | RTLD_NODELETE  # RTLD_NODELETE may be needed to avoid segfault (#929)

    libhdf5 = find_library_alt(["libhdf5"], libpaths; flags=flags)
    libhdf5_hl = find_library_alt(["libhdf5_hl"], libpaths; flags=flags)

    isempty(libhdf5) && error("libhdf5 could not be found")
    isempty(libhdf5_hl) && error("libhdf5_hl could not be found")

    libhdf5_size = filesize(dlpath(libhdf5))

    """
    # This file is automatically generated
    # Do not edit

    function check_deps()
        if libhdf5_size != filesize(Libdl.dlpath(libhdf5))
            error("HDF5 library has changed, re-run Pkg.build(\\\"HDF5\\\")")
        end
        if h5_get_libversion() < v"1.10.4"
            error("HDF5.jl requires â‰¥ v1.10.4 of the HDF5 library.")
        end
    end
    $(:(const libhdf5 = $libhdf5))
    $(:(const libhdf5_hl = $libhdf5_hl))
    $(:(const libhdf5_size = $libhdf5_size))
    """
end

if !isfile(depsfile) || new_contents != read(depsfile, String)
    # only write file if contents have changed to avoid triggering re-precompilation each build
    open(depsfile, "w") do io
        print(io, new_contents)
    end
end
